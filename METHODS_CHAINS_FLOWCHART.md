# PT Study SOP - Methods & Chains Library
## Comprehensive ASCII Flow Chart

```
╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                           COMPOSABLE METHOD LIBRARY - ARCHITECTURE                                    ║
║                                    (PEIRRO Framework)                                                 ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝


┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    LEVEL 0: DATA SOURCES                                            │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│   ┌──────────────────────┐         ┌──────────────────────┐         ┌──────────────────────┐       │
│   │  YAML Specifications │         │  Hardcoded Python    │         │   Database Tables    │       │
│   │  (SOP Library)       │         │  (seed_methods.py)   │         │   (SQLite)           │       │
│   └──────────┬───────────┘         └──────────┬───────────┘         └──────────┬───────────┘       │
│              │                                │                                │                  │
│              ▼                                ▼                                ▼                  │
│   ┌──────────────────────┐         ┌──────────────────────┐         ┌──────────────────────┐       │
│   │  methods/*.yaml      │         │  METHOD_BLOCKS[]     │         │  method_blocks       │       │
│   │  (34 method files)   │         │  (34 blocks)         │         │  (34 rows)           │       │
│   └──────────────────────┘         └──────────────────────┘         └──────────────────────┘       │
│   ┌──────────────────────┐         ┌──────────────────────┐         ┌──────────────────────┐       │
│   │  chains/*.yaml       │         │  TEMPLATE_CHAINS[]   │         │  method_chains       │       │
│   │  (15 chain files)    │         │  (15 chains)         │         │  (15 rows)           │       │
│   └──────────────────────┘         └──────────────────────┘         └──────────────────────┘       │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              LEVEL 1: METHOD BLOCKS (Atomic Units)                                  │
│                                    34 Blocks → 6 PEIRRO Phases                                      │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────┐      │
│   │  P - PREPARE (7 blocks)                                                                 │      │
│   │  ┌─────────────────┬─────────────────┬─────────────────┬─────────────────────────────┐  │      │
│   │  │ Brain Dump      │ Prediction Qs   │ Prior Knowledge │ AI Skeleton Review          │  │      │
│   │  │ (M-PRE-001)     │ (M-PRE-002)     │ Scan (M-PRE-003)│ (M-PRE-004)                 │  │      │
│   │  ├─────────────────┼─────────────────┼─────────────────┼─────────────────────────────┤  │      │
│   │  │ Concept Cluster │ Three-Layer     │ Pre-Test        │                             │  │      │
│   │  │ (M-PRE-005)     │ Chunk(M-PRE-006)│ (M-PRE-007)     │                             │  │      │
│   │  └─────────────────┴─────────────────┴─────────────────┴─────────────────────────────┘  │      │
│   └─────────────────────────────────────────────────────────────────────────────────────────┘      │
│                                                │                                                    │
│                                                ▼                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────┐      │
│   │  E - ENCODE (12 blocks)                                                                 │      │
│   │  ┌─────────────────┬─────────────────┬─────────────────┬─────────────────────────────┐  │      │
│   │  │ KWIK Hook       │ Seed-Lock Gen   │ Draw-Label      │ Teach-Back                  │  │      │
│   │  │ (M-ENC-001)     │ (M-ENC-002)     │ (M-ENC-003)     │ (M-ENC-004)                 │  │      │
│   │  ├─────────────────┼─────────────────┼─────────────────┼─────────────────────────────┤  │      │
│   │  │ Why-Chain       │ Think-Aloud     │ Self-Explanation│ Mechanism Trace             │  │      │
│   │  │ (M-ENC-005)     │ (M-ENC-006)     │ (M-ENC-007)     │ (M-ENC-008)                 │  │      │
│   │  ├─────────────────┼─────────────────┼─────────────────┼─────────────────────────────┤  │      │
│   │  │ Concept Map     │ Comparison      │ Process         │ Clinical Decision           │  │      │
│   │  │ (M-ENC-009)     │ Table(M-ENC-010)│ Flowchart       │ Tree (M-ENC-012)            │  │      │
│   │  │                 │                 │ (M-ENC-011)     │                             │  │      │
│   │  └─────────────────┴─────────────────┴─────────────────┴─────────────────────────────┘  │      │
│   └─────────────────────────────────────────────────────────────────────────────────────────┘      │
│                                                │                                                    │
│                                                ▼                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────┐      │
│   │  I - INTERROGATE (6 blocks)                                                             │      │
│   │  ┌─────────────────┬─────────────────┬─────────────────┬─────────────────────────────┐  │      │
│   │  │ Analogy Bridge  │ Clinical        │ Cross-Topic     │ Side-by-Side                │  │      │
│   │  │ (M-INT-001)     │ Application     │ Link (M-INT-003)│ Comparison(M-INT-004)       │  │      │
│   │  │                 │ (M-INT-002)     │                 │                             │  │      │
│   │  ├─────────────────┴─────────────────┼─────────────────┼─────────────────────────────┤  │      │
│   │  │ Case Walkthrough (M-INT-005)      │ Illness Script  │                             │  │      │
│   │  │                                     │ Builder(M-INT-006)│                            │  │      │
│   │  └─────────────────────────────────────┴─────────────────┴─────────────────────────────┘  │      │
│   └─────────────────────────────────────────────────────────────────────────────────────────┘      │
│                                                │                                                    │
│                                                ▼                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────┐      │
│   │  R - RETRIEVE (5 blocks)                                                                │      │
│   │  ┌─────────────────┬─────────────────┬─────────────────┬─────────────────────────────┐  │      │
│   │  │ Free Recall     │ Sprint Quiz     │ Fill-in-Blank   │ Mixed Practice              │  │      │
│   │  │ Blurt(M-RET-001)│ (M-RET-002)     │ (M-RET-003)     │ (M-RET-004)                 │  │      │
│   │  ├─────────────────┴─────────────────┴─────────────────┼─────────────────────────────┤  │      │
│   │  │ Variable Retrieval (M-RET-005)                      │                             │  │      │
│   │  └─────────────────────────────────────────────────────┴─────────────────────────────┘  │      │
│   └─────────────────────────────────────────────────────────────────────────────────────────┘      │
│                                                │                                                    │
│                                                ▼                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────┐      │
│   │  R - REFINE (2 blocks)                                                                  │      │
│   │  ┌─────────────────┬─────────────────┐                                                  │      │
│   │  │ Error Autopsy   │ Mastery Loop    │                                                  │      │
│   │  │ (M-REF-001)     │ (M-REF-002)     │                                                  │      │
│   │  └─────────────────┴─────────────────┘                                                  │      │
│   └─────────────────────────────────────────────────────────────────────────────────────────┘      │
│                                                │                                                    │
│                                                ▼                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────┐      │
│   │  O - OVERLEARN (2 blocks)                                                               │      │
│   │  ┌─────────────────┬─────────────────┐                                                  │      │
│   │  │ Exit Ticket     │ Anki Card       │                                                  │      │
│   │  │ (M-OVR-001)     │ Draft(M-OVR-002)│                                                  │      │
│   │  └─────────────────┴─────────────────┘                                                  │      │
│   └─────────────────────────────────────────────────────────────────────────────────────────┘      │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                           LEVEL 2: METHOD CHAINS (Sequenced Workflows)                              │
│                                  15 Pre-built Template Chains                                       │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                             │   │
│   │   ┌──────────────────┐      CHAIN FLOW: First Exposure (Core)                              │   │
│   │   │ C-FE-001         │      ═════════════════════════════════                             │   │
│   │   │ Name: First      │                                                                   │   │
│   │   │ Exposure (Core)  │      ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐      │   │
│   │   │ Context: First   │      │  Brain  │───▶│   AI    │───▶│  Free   │───▶│  KWIK   │      │   │
│   │   │ Exposure, High   │      │  Dump   │    │Skeleton │    │ Recall  │    │  Hook   │      │   │
│   │   │ Energy, 45 min   │      └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘      │   │
│   │   └──────────────────┘           │              │              │              │           │   │
│   │                                  ▼              ▼              ▼              ▼           │   │
│   │   BLOCKS: [PREPARE]          ─────┼────────────┼────────────┼────────────┼─────          │   │
│   │   1. M-PRE-001 Brain Dump        │              │              │              │           │   │
│   │   2. M-PRE-004 AI Skeleton       │              │              │              │           │   │
│   │   3. M-RET-001 Free Recall       │         ┌────┴──────────────┴──────────────┴───┐       │   │
│   │   4. M-ENC-001 KWIK Hook         │         │     THEN: Analogy Bridge (INT)     │       │   │
│   │   5. M-INT-001 Analogy Bridge    │         └─────────────────┬──────────────────┘       │   │
│   │   6. M-OVR-001 Exit Ticket       │                           │                          │   │
│   │                                  │                           ▼                          │   │
│   │                                  │                    ┌─────────────┐                   │   │
│   │                                  └───────────────────▶│ Exit Ticket │                   │   │
│   │                                                       │   (OVR)     │                   │   │
│   │                                                       └─────────────┘                   │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │   CORE CHAINS (8 templates)                                                                 │   │
│   ├─────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                             │   │
│   │   C-FE-001  ┌──────────────────────────────────────────────────────────────────────┐       │   │
│   │   First     │  Brain Dump ──▶ AI Skeleton ──▶ Free Recall ──▶ KWIK Hook ──▶        │       │   │
│   │   Exposure  │  Analogy Bridge ──▶ Exit Ticket                                     │       │   │
│   │   (Core)    │  [45 min, High Energy, First Exposure]                             │       │   │
│   │             └──────────────────────────────────────────────────────────────────────┘       │   │
│   │                                                                                             │   │
│   │   C-RS-001  ┌──────────────────────────────────────────────────────────────────────┐       │   │
│   │   Review    │  Prediction Qs ──▶ Sprint Quiz ──▶ Cross-Topic Link ──▶ Exit Ticket │       │   │
│   │   Sprint    │  [25 min, Medium Energy, Review]                                     │       │   │
│   │             └──────────────────────────────────────────────────────────────────────┘       │   │
│   │                                                                                             │   │
│   │   C-QD-001  ┌──────────────────────────────────────────────────────────────────────┐       │   │
│   │   Quick     │  Brain Dump ──▶ Sprint Quiz ──▶ Exit Ticket                          │       │   │
│   │   Drill     │  [15 min, Medium Energy, Review]                                     │       │   │
│   │             └──────────────────────────────────────────────────────────────────────┘       │   │
│   │                                                                                             │   │
│   │   C-AD-001  ┌──────────────────────────────────────────────────────────────────────┐       │   │
│   │   Anatomy   │  Prior Knowledge ──▶ Three-Layer ──▶ Draw-Label ──▶ Free Recall ──▶  │       │   │
│   │   Deep Dive │  Anki Card Draft                                                     │       │   │
│   │             │  [40 min, High Energy, Anatomy, First Exposure]                      │       │   │
│   │             └──────────────────────────────────────────────────────────────────────┘       │   │
│   │                                                                                             │   │
│   │   C-LE-001  ┌──────────────────────────────────────────────────────────────────────┐       │   │
│   │   Low       │  Brain Dump ──▶ AI Skeleton ──▶ Exit Ticket                          │       │   │
│   │   Energy    │  [15 min, Low Energy]                                                │       │   │
│   │             └──────────────────────────────────────────────────────────────────────┘       │   │
│   │                                                                                             │   │
│   │   C-EP-001  ┌──────────────────────────────────────────────────────────────────────┐       │   │
│   │   Exam      │  Prediction Qs ──▶ Mixed Practice ──▶ Side-by-Side ──▶ Error ──▶     │       │   │
│   │   Prep      │  Autopsy ──▶ Anki Card Draft                                         │       │   │
│   │             │  [35 min, High Energy, Exam Prep]                                    │       │   │
│   │             └──────────────────────────────────────────────────────────────────────┘       │   │
│   │                                                                                             │   │
│   │   C-CR-001  ┌──────────────────────────────────────────────────────────────────────┐       │   │
│   │   Clinical  │  Prior Knowledge ──▶ Three-Layer ──▶ Case Walkthrough ──▶ Side-by-  │       │   │
│   │   Reasoning │  Side ──▶ Error Autopsy ──▶ Anki Card Draft                           │       │   │
│   │             │  [45 min, High Energy, Clinical, Exam Prep]                          │       │   │
│   │             └──────────────────────────────────────────────────────────────────────┘       │   │
│   │                                                                                             │   │
│   │   C-MR-001  ┌──────────────────────────────────────────────────────────────────────┐       │   │
│   │   Mastery   │  Free Recall ──▶ Error Autopsy ──▶ Mastery Loop ──▶ Anki Card Draft  │       │   │
│   │   Review    │  [30 min, Medium Energy, Consolidation]                               │       │   │
│   │             └──────────────────────────────────────────────────────────────────────┘       │   │
│   │                                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │   INTAKE-FOCUSED CHAINS (4 templates)                                                       │   │
│   ├─────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                             │   │
│   │   C-DA-001  Dense Anatomy Intake:       Pre-Test ──▶ Draw-Label ──▶ Free Recall ──▶       │   │
│   │                                           KWIK Hook ──▶ Anki Card Draft [40 min]          │   │
│   │                                                                                             │   │
│   │   C-PI-001  Pathophysiology Intake:     Pre-Test ──▶ Self-Explanation ──▶ Concept         │   │
│   │                                           Cluster ──▶ Free Recall ──▶ Error Autopsy       │   │
│   │                                                                                             │   │
│   │   C-CI-001  Clinical Reasoning Intake:  Pre-Test ──▶ Illness Script ──▶ Side-by-Side      │   │
│   │                                           ──▶ Free Recall ──▶ Anki Card Draft             │   │
│   │                                                                                             │   │
│   │   C-QF-001  Quick First Exposure:       Pre-Test ──▶ AI Skeleton ──▶ Free Recall ──▶      │   │
│   │                                           Exit Ticket [20 min]                            │   │
│   │                                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │   VISUALIZATION CHAINS (2 templates)                                                        │   │
│   ├─────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                             │   │
│   │   C-VE-001  Visual Encoding:            Brain Dump ──▶ Concept Map ──▶ Comparison         │   │
│   │                                           Table ──▶ Free Recall ──▶ Exit Ticket           │   │
│   │                                                                                             │   │
│   │   C-SW-001  SWEEP (Chain Runner):       Concept Cluster ──▶ Concept Map ──▶ Comparison    │   │
│   │                                           Table ──▶ Sprint Quiz ──▶ Anki Card Draft       │   │
│   │                                                                                             │   │
│   │   C-DP-001  DEPTH (Chain Runner):       Pre-Test ──▶ Why-Chain ──▶ Mechanism Trace ──▶   │   │
│   │                                           Clinical App ──▶ Variable Retrieval ──▶ Error   │   │
│   │                                           Autopsy ──▶ Anki Card Draft                     │   │
│   │                                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                           LEVEL 3: EXECUTION ENGINE (Chain Runner)                                  │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                             │   │
│   │   chain_runner.py ────────────────────────────────────────────────────────────────┐        │   │
│   │                                                                                      │        │   │
│   │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐                 │        │   │
│   │   │  run_chain()    │───▶│  _load_chain()  │───▶│  _load_rag_     │                 │        │   │
│   │   │                 │    │                 │    │  context()      │                 │        │   │
│   │   │  Main entry     │    │  Load blocks    │    │  Load docs      │                 │        │   │
│   │   │  point          │    │  from DB        │    │  for RAG        │                 │        │   │
│   │   └────────┬────────┘    └─────────────────┘    └─────────────────┘                 │        │   │
│   │            │                                                                        │        │   │
│   │            ▼                                                                        │        │   │
│   │   ┌─────────────────────────────────────────────────────────────────┐               │        │   │
│   │   │                    EXECUTION LOOP                               │               │        │   │
│   │   │  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐      │               │        │   │
│   │   │  │ Block 1 │───▶│ Block 2 │───▶│ Block 3 │───▶│ Block N │      │               │        │   │
│   │   │  └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘      │               │        │   │
│   │   │       │              │              │              │           │               │        │   │
│   │   │       ▼              ▼              ▼              ▼           │               │        │   │
│   │   │  ┌─────────────────────────────────────────────────────────┐   │               │        │   │
│   │   │  │        get_step_prompt() [chain_prompts.py]             │   │               │        │   │
│   │   │  │  - Loads prompt template for each block                 │   │               │        │   │
│   │   │  │  - Formats with topic + RAG context + accumulated       │   │               │        │   │
│   │   │  └─────────────────────────────────────────────────────────┘   │               │        │   │
│   │   │       │                                                        │               │        │   │
│   │   │       ▼                                                        │               │        │   │
│   │   │  ┌─────────────────────────────────────────────────────────┐   │               │        │   │
│   │   │  │             call_llm() [llm_provider.py]                │   │               │        │   │
│   │   │  │  - OpenRouter API                                       │   │               │        │   │
│   │   │  │  - 90s timeout per step                                 │   │               │        │   │
│   │   │  └─────────────────────────────────────────────────────────┘   │               │        │   │
│   │   │       │                                                        │               │        │   │
│   │   │       ▼                                                        │               │        │   │
│   │   │  ┌─────────────────────────────────────────────────────────┐   │               │        │   │
│   │   │  │  Accumulate output ──▶ Next block input                 │   │               │        │   │
│   │   │  └─────────────────────────────────────────────────────────┘   │               │        │   │
│   │   └─────────────────────────────────────────────────────────────────┘               │        │   │
│   │            │                                                                        │        │   │
│   │            ▼                                                                        │        │   │
│   │   ┌─────────────────────────────────────────────────────────────────┐               │        │   │
│   │   │                    ARTIFACT GENERATION                          │               │        │   │
│   │   │  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐  │               │        │   │
│   │   │  │   Obsidian  │    │    Card     │    │     Session         │  │               │        │   │
│   │   │  │    Note     │    │   Drafts    │    │     Record          │  │               │        │   │
│   │   │  │   (Study    │    │  (Anki      │    │  (chain_runs table) │  │               │        │   │
│   │   │  │   Notes/)   │    │   cards)    │    │                     │  │               │        │   │
│   │   │  └─────────────┘    └─────────────┘    └─────────────────────┘  │               │        │   │
│   │   └─────────────────────────────────────────────────────────────────┘               │        │   │
│   │                                                                                      │        │   │
│   │   Result: run_id, chain_name, status, steps[], artifacts{}                           │        │   │
│   │                                                                                      │        │   │
│   └──────────────────────────────────────────────────────────────────────────────────────┘        │   │
│                                                                                                      │   │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
                                                                                                           │
                                                                                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                           LEVEL 4: API LAYER (Flask Blueprint)                                      │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│   api_methods.py ─────────────────────────────────────────────────────────────────────────────     │
│                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │   METHOD BLOCK ENDPOINTS                                                                    │   │
│   ├─────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                             │   │
│   │   GET    /api/methods              ──▶ list_methods()      ──▶ List all blocks              │   │
│   │   GET    /api/methods?category=X   ──▶ Filter by category                                   │   │
│   │   GET    /api/methods/<id>         ──▶ get_method()        ──▶ Single block details         │   │
│   │   POST   /api/methods              ──▶ create_method()     ──▶ Create new block             │   │
│   │   PUT    /api/methods/<id>         ──▶ update_method()     ──▶ Update block                 │   │
│   │   DELETE /api/methods/<id>         ──▶ delete_method()     ──▶ Delete block                 │   │
│   │                                                                                             │   │
│   │   POST   /api/methods/<id>/rate    ──▶ rate_method()       ──▶ Rate effectiveness           │   │
│   │                                     (1-5 scale, with context)                               │   │
│   │                                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │   METHOD CHAIN ENDPOINTS                                                                    │   │
│   ├─────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                             │   │
│   │   GET    /api/chains               ──▶ list_chains()       ──▶ List all chains              │   │
│   │   GET    /api/chains?template=1    ──▶ Filter templates                                     │   │
│   │   GET    /api/chains/<id>          ──▶ get_chain()         ──▶ Single chain + blocks        │   │
│   │   POST   /api/chains               ──▶ create_chain()      ──▶ Create new chain             │   │
│   │   PUT    /api/chains/<id>          ──▶ update_chain()      ──▶ Update chain                 │   │
│   │   DELETE /api/chains/<id>          ──▶ delete_chain()      ──▶ Delete chain                 │   │
│   │                                                                                             │   │
│   │   POST   /api/chains/<id>/rate     ──▶ rate_chain()        ──▶ Rate chain effectiveness      │   │
│   │                                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │   ANALYTICS ENDPOINTS                                                                       │   │
│   ├─────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                             │   │
│   │   GET    /api/methods/analytics    ──▶ method_analytics()                                   │   │
│   │                                         - block_stats: avg effectiveness, usage count       │   │
│   │                                         - chain_stats: avg effectiveness per chain          │   │
│   │                                         - recent_ratings: last 20 ratings                   │   │
│   │                                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                           LEVEL 5: DATABASE SCHEMA                                                  │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │   method_blocks TABLE                                                                       │   │
│   ├─────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                             │   │
│   │   id INTEGER PK             ──▶ Unique block ID                                           │   │
│   │   name TEXT NOT NULL        ──▶ Block name (e.g., "Brain Dump")                           │   │
│   │   category TEXT NOT NULL    ──▶ PEIRRO phase                                              │   │
│   │   description TEXT          ──▶ What the block does                                       │   │
│   │   default_duration_min INT  ──▶ Typical minutes (default: 5)                              │   │
│   │   energy_cost TEXT          ──▶ low/medium/high (default: medium)                         │   │
│   │   best_stage TEXT           ──▶ first_exposure/review/exam_prep/consolidation             │   │
│   │   tags TEXT (JSON)          ──▶ Array of descriptors                                      │   │
│   │   evidence TEXT             ──▶ Research citation                                         │   │
│   │   created_at TIMESTAMP      ──▶ Creation time                                             │   │
│   │                                                                                             │   │
│   │   INDEX: idx_method_blocks_category ──▶ Fast category filtering                           │   │
│   │                                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │   method_chains TABLE                                                                       │   │
│   ├─────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                             │   │
│   │   id INTEGER PK             ──▶ Unique chain ID                                           │   │
│   │   name TEXT NOT NULL        ──▶ Chain name                                                │   │
│   │   description TEXT          ──▶ When to use this chain                                    │   │
│   │   block_ids TEXT (JSON)     ──▶ Ordered array of method_block IDs                         │   │
│   │   context_tags TEXT (JSON)  ──▶ {stage, energy, time_available, class_type}               │   │
│   │   is_template INTEGER       ──▶ 1 = pre-built, 0 = custom (default: 0)                    │   │
│   │   created_at TIMESTAMP      ──▶ Creation time                                             │   │
│   │                                                                                             │   │
│   │   INDEX: idx_method_chains_template ──▶ Fast template filtering                           │   │
│   │                                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │   method_ratings TABLE                                                                      │   │
│   ├─────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                             │   │
│   │   id INTEGER PK             ──▶ Unique rating ID                                          │   │
│   │   method_block_id INT FK    ──▶ Links to method_blocks (NULL if chain rating)             │   │
│   │   chain_id INT FK           ──▶ Links to method_chains (NULL if block rating)             │   │
│   │   session_id INT FK         ──▶ Links to sessions                                         │   │
│   │   effectiveness INT         ──▶ 1-5 rating                                                │   │
│   │   engagement INT            ──▶ 1-5 rating                                                │   │
│   │   notes TEXT                ──▶ Free text feedback                                        │   │
│   │   context TEXT (JSON)       ──▶ Actual context tags                                       │   │
│   │   rated_at TIMESTAMP        ──▶ Rating time                                               │   │
│   │                                                                                             │   │
│   │   INDEX: idx_method_ratings_block ──▶ Block analytics                                     │   │
│   │   INDEX: idx_method_ratings_chain ──▶ Chain analytics                                     │   │
│   │                                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │   chain_runs TABLE                                                                          │   │
│   ├─────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                             │   │
│   │   id INTEGER PK             ──▶ Unique run ID                                             │   │
│   │   chain_id INT FK           ──▶ Links to method_chains                                    │   │
│   │   session_id INT FK         ──▶ Links to sessions (when completed)                        │   │
│   │   topic TEXT NOT NULL       ──▶ Study topic                                               │   │
│   │   course_id INT             ──▶ Optional course context                                   │   │
│   │   status TEXT               ──▶ running/completed/failed                                  │   │
│   │   current_step INT          ──▶ Progress tracking                                         │   │
│   │   total_steps INT           ──▶ Total blocks in chain                                     │   │
│   │   run_state_json TEXT       ──▶ Serialized state                                          │   │
│   │   artifacts_json TEXT       ──▶ Generated artifacts (paths, IDs)                          │   │
│   │   started_at TIMESTAMP      ──▶ Run start time                                            │   │
│   │   completed_at TIMESTAMP    ──▶ Run end time                                              │   │
│   │   error_message TEXT        ──▶ If failed                                                 │   │
│   │                                                                                             │   │
│   │   INDEX: idx_chain_runs_chain ──▶ Per-chain history                                       │   │
│   │   INDEX: idx_chain_runs_status ──▶ Active runs query                                      │   │
│   │                                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │   library_meta TABLE                                                                        │   │
│   ├─────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                             │   │
│   │   id INTEGER PK             ──▶ Unique entry                                              │   │
│   │   library_version TEXT      ──▶ YAML version or "legacy"                                  │   │
│   │   source_sha TEXT           ──▶ Git commit SHA                                            │   │
│   │   seeded_at TIMESTAMP       ──▶ When library was seeded                                   │   │
│   │   method_count INT          ──▶ Number of methods seeded                                  │   │
│   │   chain_count INT           ──▶ Number of chains seeded                                   │   │
│   │                                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                           LEVEL 6: DATA FLOW & INTEGRATION                                          │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│   SEEDING FLOW (seed_methods.py)                                                                    │
│   ═══════════════════════════════════════════════════════════════════════════════════════════      │
│                                                                                                      │
│        ┌───────────────┐                                                                            │
│        │  Check YAML   │──NO──▶┌────────────────┐                                                  │
│        │   Exists?     │        │ Use Hardcoded  │                                                  │
│        └───────┬───────┘        │ METHOD_BLOCKS[]│                                                  │
│                │                │ TEMPLATE_CHAINS│                                                  │
│               YES               └────────────────┘                                                  │
│                │                       │                                                            │
│                ▼                       ▼                                                            │
│        ┌───────────────┐        ┌────────────────┐        ┌────────────────┐        ┌───────────┐  │
│        │ Load YAML     │        │ Parse Blocks   │──▶────▶│ Insert into    │──▶────▶│ Update    │  │
│        │ methods/      │───────▶│ & Chains       │        │ method_blocks  │        │ library_  │  │
│        │ chains/       │        │                │        │ method_chains  │        │ meta      │  │
│        └───────────────┘        └────────────────┘        └────────────────┘        └───────────┘  │
│                                                                                                      │
│   CHAIN RUNNER FLOW                                                                                 │
│   ═══════════════════════════════════════════════════════════════════════════════════════════      │
│                                                                                                      │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐   │
│   │  INPUT   │───▶│  LOAD    │───▶│   RAG    │───▶│ EXECUTE  │───▶│ ARTIFACT │───▶│  OUTPUT  │   │
│   │          │    │  CHAIN   │    │  CONTEXT │    │  BLOCKS  │    │  GENERATE│    │          │   │
│   └──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘   │
│        │              │              │              │              │              │              │
│        ▼              ▼              ▼              ▼              ▼              ▼              │
│   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐       │
│   │ chain_id │   │ Blocks[] │   │ rag_docs │   │ For each │   │ Obsidian │   │ run_id   │       │
│   │ topic    │   │ Name/    │   │ content  │   │ block:   │   │ Note     │   │ status   │       │
│   │ course_id│   │ Category │   │ (capped) │   │  - Prompt│   │ Card     │   │ steps[]  │       │
│   │ options{}│   │          │   │          │   │  - LLM   │   │ Drafts   │   │ artifacts│       │
│   │          │   │          │   │          │   │  - Accum │   │ Session  │   │          │       │
│   └──────────┘   └──────────┘   └──────────┘   └──────────┘   └──────────┘   └──────────┘       │
│                                                                                                      │
│   PROMPT TEMPLATES (chain_prompts.py)                                                               │
│   ═══════════════════════════════════════════════════════════════════════════════════════════      │
│                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────┐      │
│   │  Each block has a registered prompt template via _register(name, system_suffix, user_tpl)│     │
│   │                                                                                         │      │
│   │  Template Variables:                                                                    │      │
│   │  • {topic}           ──▶ Study topic from user input                                    │      │
│   │  • {rag_context}     ──▶ Source material from RAG docs (capped at 2000 chars)          │      │
│   │  • {accumulated}     ──▶ Output from all previous blocks in chain                      │      │
│   │                                                                                         │      │
│   │  Example: Concept Map block generates Mermaid diagram syntax                           │      │
│   │  Example: Anki Card Draft parses structured CARD N: TYPE: FRONT: BACK: TAGS: format    │      │
│   │                                                                                         │      │
│   └─────────────────────────────────────────────────────────────────────────────────────────┘      │
│                                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘


╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                              CONTEXT MATCHING & RECOMMENDATIONS                                       ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│   CONTEXT DIMENSIONS                                                                                │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐            │
│   │   class_type    │   │     stage       │   │     energy      │   │  time_available │            │
│   ├─────────────────┤   ├─────────────────┤   ├─────────────────┤   ├─────────────────┤            │
│   │ • anatomy       │   │ • first_exposure│   │ • low (1-4)     │   │ • minutes       │            │
│   │ • physiology    │   │ • review        │   │ • medium (5-7)  │   │                 │            │
│   │ • pathology     │   │ • exam_prep     │   │ • high (8-10)   │   │                 │            │
│   │ • pharmacology  │   │ • consolidation │   │                 │   │                 │            │
│   │ • clinical      │   │                 │   │                 │   │                 │            │
│   │ • general       │   │                 │   │                 │   │                 │            │
│   └─────────────────┘   └─────────────────┘   └─────────────────┘   └─────────────────┘            │
│                                                                                                     │
│   CHAIN SELECTION ALGORITHM:                                                                        │
│                                                                                                     │
│   score = Σ(context_tag_match ? 1 : 0) / total_context_tags                                         │
│                                                                                                     │
│   Exact matches preferred → Partial matches allowed → Score threshold for recommendation            │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘


╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                    FILE STRUCTURE REFERENCE                                           ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝

pt-study-sop/
│
├── brain/
│   ├── chain_prompts.py          # Prompt templates for each method block
│   ├── chain_runner.py           # Core execution engine for chains
│   ├── data/
│   │   └── seed_methods.py       # Hardcoded fallback data + YAML loader
│   └── dashboard/
│       └── api_methods.py        # Flask REST API for methods/chains
│
├── sop/
│   └── library/
│       ├── methods/              # 34 YAML method block definitions
│       │   ├── M-PRE-001.yaml    # Brain Dump
│       │   ├── M-PRE-002.yaml    # Prediction Questions
│       │   ├── ... (34 files total)
│       │   └── M-OVR-002.yaml    # Anki Card Draft
│       │
│       ├── chains/               # 15 YAML chain definitions
│       │   ├── C-FE-001.yaml     # First Exposure (Core)
│       │   ├── C-RS-001.yaml     # Review Sprint
│       │   ├── ... (15 files total)
│       │   └── C-DP-001.yaml     # DEPTH (Chain Runner)
│       │
│       ├── meta/
│       │   ├── taxonomy.yaml     # Classification system
│       │   └── version.yaml      # Library version
│       │
│       └── 15-method-library.md  # Full documentation
│
└── METHODS_CHAINS_FLOWCHART.md   # This file


╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                    KEY INSIGHTS & PATTERNS                                            ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝

1. PEIRRO FRAMEWORK
   └─> 6 phases that map to cognitive processes: Prepare → Encode → Interrogate → Retrieve → Refine → Overlearn

2. MODULAR DESIGN
   └─> Method blocks are atomic and composable
   └─> Chains are ordered sequences without hardcoded logic between blocks
   └─> Accumulated context passes from block to block via LLM prompts

3. EVIDENCE-BASED
   └─> Every block cites research (author, year, finding)
   └─> Ratings system allows data-driven optimization

4. CHAIN RUNNER ARCHITECTURE
   └─> Stateless execution (all context in prompts)
   └─> RAG integration for source-grounded outputs
   └─> Automatic artifact generation (Obsidian, Anki, Session record)

5. DUAL DATA SOURCES
   └─> YAML files (primary, editable)
   └─> Hardcoded Python (fallback, immutable)
   └─> Database (runtime, mutable via ratings)

6. PROMPT ENGINEERING STRATEGY
   └─> Block-specific templates in chain_prompts.py
   └─> System prompt sets persona (PT study tutor)
   └─> User prompt includes topic + RAG + accumulated context
   └─> Consistent output formats (Mermaid, CARD N: format, etc.)
