import{r as c,j as s}from"./index-DQdAKonc.js";import{F as U}from"./react-force-graph-2d-DjHp7Sm5.js";import{u as k,S as V,p as S}from"./layout-veyEtZar.js";import{C as b}from"./checkbox-DG1NANI0.js";import"./zoom-DwwqPMg_.js";import"./index-Ch5KUB_m.js";const _={course:"#22d3ee",module:"#facc15",lo:"#4ade80"},Q={course:"rgba(34,211,238,0.15)",module:"rgba(250,204,21,0.12)",lo:"rgba(74,222,128,0.08)"};function ne(){const M=c.useRef(null),B=c.useRef(null),O=c.useRef(!1),[j,T]=c.useState(null),[y,R]=c.useState(new Set),[x,I]=c.useState(new Set),[f,$]=c.useState(!0),[L,A]=c.useState(null),{data:d=[]}=k({queryKey:["courses"],queryFn:()=>S.courses.getActive()}),E=d.map(e=>e.id).sort(),{data:v=[]}=k({queryKey:["modules","all",E],queryFn:async()=>(await Promise.all(d.map(t=>S.modules.getByCourse(t.id)))).flat(),enabled:d.length>0}),{data:z=[]}=k({queryKey:["learningObjectives","all",E,f],queryFn:async()=>(await Promise.all(d.map(t=>S.learningObjectives.getByCourse(t.id)))).flat(),enabled:d.length>0&&f});c.useEffect(()=>{const e=M.current;if(!e)return;const t=()=>{const a=e.getBoundingClientRect();T({width:Math.max(1,Math.floor(a.width)-2),height:Math.max(1,Math.floor(a.height)-2)})};t();const n=new ResizeObserver(t);return n.observe(e),()=>n.disconnect()},[]),c.useEffect(()=>{d.length>0&&!O.current&&(O.current=!0,R(new Set(d.map(e=>e.id))))},[d]);const g=c.useMemo(()=>{const e=[],t=[],n=new Map;for(const o of v){const r=n.get(o.courseId)??[];r.push(o),n.set(o.courseId,r)}const a=new Map;for(const o of z){const r=a.get(o.moduleId)??[];r.push(o),a.set(o.moduleId,r)}for(const o of d){if(!y.has(o.id))continue;const r=`course-${o.id}`;e.push({id:r,name:o.name,type:"course"});const i=n.get(o.id)??[];for(const l of i){if(x.size>0&&!x.has(l.id))continue;const u=`module-${l.id}`;if(e.push({id:u,name:l.name,type:"module"}),t.push({source:r,target:u}),f){const p=a.get(l.id)??[];for(const m of p){const h=`lo-${m.id}`;e.push({id:h,name:`${m.loCode}: ${m.title}`,type:"lo"}),t.push({source:u,target:h})}}}}return{nodes:e,links:t}},[d,v,z,y,x,f]),F=e=>{R(t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})},W=e=>{I(t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})},H=c.useCallback((e,t,n)=>{const a=_[e.type]||"#6366f1",o=Q[e.type]||"rgba(99,102,241,0.1)",r=L===e.id,i=e.x||0,l=e.y||0,u=e.type==="course"?14:e.type==="module"?11:9,p=Math.max(u/n,2);t.font=`${e.type==="course"?"bold ":""}${p}px monospace`;const m=e.type==="lo"?50:35,h=e.name.length>m?e.name.slice(0,m)+"...":e.name,N=t.measureText(h).width,w=8/n,C=5/n,P=N+w*2,q=p+C*2,Y=4/n;t.beginPath(),t.roundRect(i-P/2,l-q/2,P,q,Y),t.fillStyle=r?a:o,t.fill(),t.strokeStyle=r?"#ffffff":a,t.lineWidth=(e.type==="course"?2:1)/n,t.stroke(),t.textAlign="center",t.textBaseline="middle",t.fillStyle=r?"#000000":a,t.fillText(h,i,l)},[L]),G=c.useCallback((e,t,n,a)=>{const o=e.x||0,r=e.y||0,l=(e.type==="course"?60:e.type==="module"?45:30)/a;n.fillStyle=t,n.fillRect(o-l/2,r-l/2,l,l)},[]),K=c.useCallback((e,t,n)=>{const a=e.source,o=e.target;if(!a||!o)return;const r=a.x||0,i=a.y||0,l=o.x||0,u=o.y||0,p=(r+l)/2,m=(i+u)/2,h=l-r,N=u-i,w=p-N*.15,C=m+h*.15;t.beginPath(),t.moveTo(r,i),t.quadraticCurveTo(w,C,l,u),t.strokeStyle="rgba(148, 163, 184, 0.25)",t.lineWidth=Math.max(1.5/n,.3),t.stroke()},[]),D=v.filter(e=>y.has(e.courseId));return s.jsxs("div",{className:"flex h-full",children:[s.jsx("div",{className:"w-[220px] shrink-0 border-r border-secondary/30 bg-black/60",children:s.jsx(V,{className:"h-full",children:s.jsxs("div",{className:"p-3 space-y-4",children:[s.jsxs("div",{children:[s.jsx("div",{className:"font-arcade text-[10px] text-primary mb-2",children:"COURSES"}),d.map(e=>s.jsxs("label",{className:"flex items-center gap-2 py-1 cursor-pointer",children:[s.jsx(b,{checked:y.has(e.id),onCheckedChange:()=>F(e.id),className:"border-cyan-500 data-[state=checked]:bg-cyan-500"}),s.jsx("span",{className:"font-terminal text-xs text-cyan-300",children:e.name})]},e.id))]}),D.length>0&&s.jsxs("div",{children:[s.jsx("div",{className:"font-arcade text-[10px] text-yellow-400 mb-2",children:"MODULES"}),s.jsxs("label",{className:"flex items-center gap-2 py-1 cursor-pointer mb-1",children:[s.jsx(b,{checked:x.size===0,onCheckedChange:()=>I(new Set),className:"border-yellow-500 data-[state=checked]:bg-yellow-500"}),s.jsx("span",{className:"font-terminal text-xs text-yellow-200",children:"All Modules"})]}),D.map(e=>s.jsxs("label",{className:"flex items-center gap-2 py-0.5 cursor-pointer",children:[s.jsx(b,{checked:x.size===0||x.has(e.id),onCheckedChange:()=>W(e.id),className:"border-yellow-500 data-[state=checked]:bg-yellow-500"}),s.jsx("span",{className:"font-terminal text-[10px] text-yellow-100 truncate",children:e.name})]},e.id))]}),s.jsx("div",{children:s.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[s.jsx(b,{checked:f,onCheckedChange:e=>$(!!e),className:"border-green-500 data-[state=checked]:bg-green-500"}),s.jsx("span",{className:"font-terminal text-xs text-green-300",children:"Show Learning Objectives"})]})}),s.jsxs("div",{className:"pt-2 border-t border-secondary/30 space-y-1",children:[s.jsx("div",{className:"font-arcade text-[10px] text-muted-foreground mb-1",children:"LEGEND"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-3 h-3 rounded-sm border-2 border-cyan-400 bg-cyan-400/15"}),s.jsx("span",{className:"font-terminal text-[10px] text-cyan-300",children:"Course"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-3 h-3 rounded-sm border border-yellow-400 bg-yellow-400/12"}),s.jsx("span",{className:"font-terminal text-[10px] text-yellow-300",children:"Module"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-3 h-3 rounded-sm border border-green-400 bg-green-400/8"}),s.jsx("span",{className:"font-terminal text-[10px] text-green-300",children:"Learning Objective"})]})]}),s.jsxs("div",{className:"pt-2 border-t border-secondary/30 font-terminal text-[10px] text-muted-foreground",children:[s.jsxs("div",{children:["Nodes: ",g.nodes.length]}),s.jsxs("div",{children:["Links: ",g.links.length]})]})]})})}),s.jsxs("div",{ref:M,className:"flex-1 relative bg-black/80 overflow-hidden",children:[j&&g.nodes.length>0&&s.jsx(U,{ref:B,graphData:g,width:j.width,height:j.height,dagMode:"lr",dagLevelDistance:120,nodeCanvasObject:H,nodePointerAreaPaint:G,linkCanvasObject:K,onNodeHover:e=>A(e?.id??null),linkColor:()=>"transparent",linkWidth:0,backgroundColor:"transparent",cooldownTicks:100,d3AlphaDecay:.025,d3VelocityDecay:.35}),g.nodes.length===0&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center font-terminal text-xs text-muted-foreground",children:"Select courses to build mind map"})]})]})}export{ne as MindMapView};
