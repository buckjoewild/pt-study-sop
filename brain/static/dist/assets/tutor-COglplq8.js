import{c as H,j as e,r as n,d as pe,X as Ne}from"./index-BXuiyTYN.js";import{u as Y,p as _,S as he,B as U,n as fe,o as je,m as be,L as Se}from"./layout-7PdAu0MB.js";import{C as W}from"./card-CTx1CiD2.js";import{I as k,T as O,a as G,b as K,P as V,c as ge,S as Ce,d as oe,e as ie,M as ke,B as _e,f as te,g as se,h as we,t as b}from"./MaterialUploader-CgYWi8HL.js";import{B as D}from"./badge-CRfATWdL.js";import{C as re}from"./checkbox-c6Y6TXcX.js";import{L as ne}from"./loader-circle-OaBLjxG6.js";import{F as J}from"./file-text-463gNGSf.js";import{D as Ee,M as $e,r as Te,F as Ae}from"./index-CebIAvJU.js";import{L as Oe}from"./link-ANKoFkz_.js";import{Z as De}from"./zap-BWxFgZaZ.js";import{C as Le}from"./index-X1CQgm3T.js";import{S as Me}from"./send-CqwRm2eU.js";import{M as ce}from"./message-square-D3lI-vcK.js";import{C as le}from"./clock-BxIRkrpC.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]],Re=H("cloud",Pe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]],ye=H("credit-card",Ie);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=[["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M17 20v2",key:"1rnc9c"}],["path",{d:"M17 2v2",key:"11trls"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M2 17h2",key:"7oei6x"}],["path",{d:"M2 7h2",key:"asdhe0"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"M20 17h2",key:"1fpfkl"}],["path",{d:"M20 7h2",key:"1o8tra"}],["path",{d:"M7 20v2",key:"4gnj0m"}],["path",{d:"M7 2v2",key:"1i4yhu"}],["rect",{x:"4",y:"4",width:"16",height:"16",rx:"2",key:"1vbyd7"}],["rect",{x:"8",y:"8",width:"8",height:"8",rx:"1",key:"z9xiuo"}]],qe=H("cpu",Fe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]],ve=H("map",Ue);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],Ge=H("square",Ke),Qe={pdf:"PDF",docx:"DOC",pptx:"PPT",md:"MD",txt:"TXT"};function Xe({courseId:l,selectedMaterials:o,setSelectedMaterials:N}){const{data:f=[],isLoading:u}=Y({queryKey:["tutor-materials",l],queryFn:()=>_.tutor.getMaterials(l?{course_id:l}:void 0)}),w=c=>{N(o.includes(c)?o.filter(L=>L!==c):[...o,c])},v=()=>{o.length===f.length?N([]):N(f.map(c=>c.id))};return u?e.jsx("div",{className:"flex items-center justify-center py-3",children:e.jsx(ne,{className:`${k} animate-spin text-muted-foreground`})}):f.length===0?e.jsx("div",{className:`${O} text-center py-2`,children:"No materials uploaded yet"}):e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:`flex items-center gap-1.5 px-1 py-0.5 ${G} text-muted-foreground hover:text-foreground cursor-pointer border-b border-muted-foreground/10 pb-1`,children:[e.jsx(re,{checked:f.length>0&&o.length===f.length,onCheckedChange:v,className:"w-3 h-3"}),e.jsx("span",{children:"Select all"}),e.jsxs(D,{variant:"outline",className:`ml-auto ${K} h-4 px-1`,children:[o.length,"/",f.length]})]}),f.map(c=>e.jsxs("label",{className:`flex items-center gap-1.5 px-1 py-0.5 ${G} text-muted-foreground hover:text-foreground cursor-pointer`,children:[e.jsx(re,{checked:o.includes(c.id),onCheckedChange:()=>w(c.id),className:"w-3 h-3"}),e.jsx(J,{className:`${k} text-primary/60 shrink-0`}),e.jsx("span",{className:"truncate flex-1",children:c.title}),e.jsx(D,{variant:"outline",className:`${K} h-4 px-1 shrink-0`,children:Qe[c.file_type]||c.file_type.toUpperCase()})]},c.id))]})}const Z=[{value:"arcee-ai/trinity-large-preview:free",label:"Trinity Large (free)"},{value:"qwen/qwen3-coder-next",label:"Qwen3 Coder Next"},{value:"google/gemini-2.5-flash-lite",label:"Gemini 2.5 Flash Lite"}],ze=[{value:"Core",label:"LEARN",desc:"Teach first"},{value:"Sprint",label:"REVIEW",desc:"Test first"},{value:"Quick Sprint",label:"QUICK",desc:"Fast spacing"},{value:"Light",label:"LIGHT",desc:"Low energy"},{value:"Drill",label:"FIX",desc:"Targeted"}],Be=["Teaching Sprint","Diagnostic Sprint"],de={Core:"First Exposure (Core)",Sprint:"Review Sprint","Quick Sprint":"Quick Drill",Light:"Low Energy",Drill:"Mastery Review","Teaching Sprint":"First Exposure (Core)","Diagnostic Sprint":"Review Sprint"},ue="tutor.autopick_chain.v1",me="tutor.last_openrouter_model.v1",xe="tutor.last_codex_model.v1";function ae(l){try{return localStorage.getItem(l)}catch{return null}}function ee(l,o){try{localStorage.setItem(l,o)}catch{}}function Ye(l,o){const N=ae(l);return N===null?o:N==="true"}function X({children:l,icon:o}){return e.jsxs("div",{className:`${se} flex items-center gap-1.5 pb-1 border-b border-primary/20 mb-2`,children:[o,l]})}function Ve({courseId:l,setCourseId:o,selectedMaterials:N,setSelectedMaterials:f,mode:u,setMode:w,chainId:v,setChainId:c,topic:L,setTopic:S,model:d,setModel:h,onStartSession:T,isStarting:M,hasActiveSession:E}){const{data:s}=Y({queryKey:["tutor-content-sources"],queryFn:()=>_.tutor.getContentSources()}),{data:i=[]}=Y({queryKey:["tutor-template-chains"],queryFn:()=>_.tutor.getTemplateChains()}),{data:y=[]}=Y({queryKey:["courses-active"],queryFn:()=>_.courses.getActive()}),r=s?.openrouter_enabled??!1,m=d.includes("/")?"openrouter":"codex";n.useEffect(()=>{!r&&m==="openrouter"&&h("codex")},[r,m,h]),n.useEffect(()=>{d&&(d.includes("/")?ee(me,d):ee(xe,d))},[d]);const[x,R]=n.useState(()=>Ye(ue,!0)),[j,P]=n.useState(null);n.useEffect(()=>{ee(ue,String(x))},[x]);const $=de[u],C=n.useMemo(()=>{if($)return i.find(t=>t.name===$)},[i,$]);n.useEffect(()=>{x&&v===void 0&&C&&j!==u&&(c(C.id),P(u))},[x,v,C?.id,j,u,c]);const I=t=>{if(w(t),!x||v!==void 0)return;const A=de[t];if(!A)return;const Q=i.find(B=>B.name===A);Q&&(c(Q.id),P(t))},z=()=>{const t=ae(xe),A=t&&!t.includes("/")?t:"codex";h(A)},F=()=>{if(!r)return;const t=ae(me),A=t&&t.includes("/")?t:Z[0].value;h(A)};return n.useEffect(()=>{m==="openrouter"&&(Z.some(t=>t.value===d)||h(Z[0].value))},[m,d,h]),e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:`shrink-0 ${V} pb-2 border-b-2 border-primary/30`,children:[e.jsx("div",{className:ge,children:"CONTENT FILTER"}),e.jsxs("div",{className:`flex items-center gap-2 mt-1 ${O}`,children:[e.jsx(Ee,{className:k}),s?.total_materials??0," materials",e.jsx("span",{className:"text-muted-foreground/40",children:"|"}),s?.total_instructions??0," SOP"]})]}),e.jsx(he,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:`${V} ${Ce}`,children:[e.jsxs("div",{children:[e.jsx(X,{children:"Mode"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:ze.map(t=>e.jsxs("button",{onClick:()=>I(t.value),className:`text-left px-2 py-1 border-2 transition-colors ${u===t.value?"border-primary bg-primary/20 text-primary":"border-muted-foreground/20 hover:border-primary/40 text-muted-foreground"}`,children:[e.jsx("div",{className:"font-arcade text-[10px] leading-tight",children:t.label}),e.jsx("div",{className:`${O} leading-tight`,children:t.desc})]},t.value))}),Be.includes(u)&&e.jsxs("div",{className:`${O} mt-1`,children:["Legacy mode active: ",u]})]}),e.jsxs("div",{children:[e.jsx(X,{icon:e.jsx(Oe,{className:k}),children:"Chain"}),e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[e.jsxs("div",{className:`${O} min-w-0`,children:[e.jsx("span",{className:"opacity-70",children:"Recommended:"})," ",C?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-foreground truncate",children:C.name}),e.jsx(D,{variant:"outline",className:`ml-1.5 ${K} h-4 px-1`,children:C.blocks.length})]}):e.jsx("span",{className:"opacity-70",children:"—"})]}),C&&v!==C.id&&e.jsx(U,{size:"sm",variant:"outline",onClick:()=>c(C.id),className:"rounded-none h-6 px-2 font-arcade text-[9px] border-primary/50 hover:bg-primary/10",children:"APPLY"})]}),e.jsxs("label",{className:`flex items-center gap-2 ${G} text-muted-foreground mb-1 cursor-pointer`,children:[e.jsx(re,{checked:x,onCheckedChange:t=>R(t===!0),className:"w-3 h-3"}),e.jsx("span",{className:"select-none",children:"Auto-pick recommended chain"})]}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("button",{onClick:()=>{c(void 0),P(u)},className:`w-full text-left px-2 py-0.5 ${G} border-l-2 transition-colors ${v?"border-transparent text-muted-foreground hover:text-foreground hover:border-primary/30":"border-primary text-primary bg-primary/10"}`,children:"Freeform"}),i.map(t=>e.jsxs("button",{onClick:()=>c(t.id),className:`w-full text-left px-2 py-0.5 ${G} border-l-2 transition-colors ${v===t.id?"border-primary text-primary bg-primary/10":"border-transparent text-muted-foreground hover:text-foreground hover:border-primary/30"}`,children:[e.jsx("span",{className:"truncate",children:t.name}),e.jsx(D,{variant:"outline",className:`ml-1.5 ${K} h-4 px-1`,children:t.blocks.length})]},t.id))]})]}),e.jsxs("div",{children:[e.jsx(X,{children:"Topic"}),e.jsx("input",{value:L,onChange:t=>S(t.target.value),placeholder:"e.g. Hip Flexors",className:oe})]}),e.jsxs("div",{children:[e.jsx(X,{children:"Model"}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 mb-1",children:[e.jsxs("button",{onClick:z,className:`text-left px-2 py-1 border-2 transition-colors ${m==="codex"?"border-primary bg-primary/20 text-primary":"border-muted-foreground/20 hover:border-primary/40 text-muted-foreground"}`,children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(qe,{className:k}),e.jsx("div",{className:"font-arcade text-[10px] leading-tight",children:"CODEX"})]}),e.jsx("div",{className:`${O} leading-tight`,children:"ChatGPT login"})]}),e.jsxs("button",{onClick:F,disabled:!r,className:`text-left px-2 py-1 border-2 transition-colors ${m==="openrouter"?"border-primary bg-primary/20 text-primary":"border-muted-foreground/20 hover:border-primary/40 text-muted-foreground"} ${r?"":"opacity-50 cursor-not-allowed"}`,children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Re,{className:k}),e.jsx("div",{className:"font-arcade text-[10px] leading-tight",children:"OPENROUTER"})]}),e.jsx("div",{className:`${O} leading-tight`,children:r?"API key enabled":"API key missing"})]})]}),m==="openrouter"?e.jsx("select",{value:d,onChange:t=>h(t.target.value),className:ie,children:Z.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}):e.jsx("input",{value:d==="codex"?"":d,onChange:t=>h(t.target.value.trim()?t.target.value:"codex"),placeholder:"Codex model override (optional)",className:oe})]}),e.jsxs("div",{children:[e.jsx(X,{children:"Course"}),e.jsxs("select",{value:l??"",onChange:t=>o(t.target.value?Number(t.target.value):void 0),className:ie,children:[e.jsx("option",{value:"",children:"All courses"}),y.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx(X,{icon:e.jsx(J,{className:k}),children:"Materials"}),e.jsx(Xe,{courseId:l,selectedMaterials:N,setSelectedMaterials:f})]}),e.jsxs("div",{className:"border-t border-primary/10 pt-2",children:[e.jsx(X,{children:"Upload"}),e.jsx(ke,{courseId:l})]})]})}),e.jsx("div",{className:`shrink-0 ${V} pt-2 border-t-2 border-primary/30`,children:e.jsxs(U,{onClick:T,disabled:M||E,className:_e,children:[M?e.jsx(ne,{className:`${te} animate-spin mr-1.5`}):e.jsx(De,{className:`${te} mr-1.5`}),E?"SESSION ACTIVE":"START SESSION"]})})]})}function He({sessionId:l,onArtifactCreated:o,onSessionEnd:N,chainBlocks:f=[],currentBlockIndex:u=0,onAdvanceBlock:w}){const v=f.length>0,c=v&&u>=f.length,[L,S]=n.useState([]),[d,h]=n.useState(""),[T,M]=n.useState(!1),E=n.useRef(null),s=n.useRef(null);n.useEffect(()=>{E.current&&(E.current.scrollTop=E.current.scrollHeight)},[L]),n.useEffect(()=>{s.current?.focus()},[l]);const i=n.useCallback(async()=>{if(!d.trim()||!l||T)return;const r=d.trim();h("");const m=/^\/(note|save)\b/i.test(r),x=/^\/(card|flashcard)\b/i.test(r),R=/^\/(map|diagram)\b/i.test(r);S(j=>[...j,{role:"user",content:r}]),S(j=>[...j,{role:"assistant",content:"",isStreaming:!0}]),M(!0);try{const P=(await fetch(`/api/tutor/session/${l}/turn`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:r})})).body?.getReader(),$=new TextDecoder;if(!P)throw new Error("No response body");let C="",I="",z=[];for(;;){const{done:F,value:t}=await P.read();if(F)break;C+=$.decode(t,{stream:!0});const A=C.split(`
`);C=A.pop()??"";for(const Q of A){if(!Q.startsWith("data: "))continue;const B=Q.slice(6);if(B==="[DONE]")break;try{const a=JSON.parse(B);if(a.type==="error"){S(p=>{const g=[...p];return g[g.length-1]={role:"assistant",content:`Error: ${a.content}`},g}),M(!1);return}a.type==="token"&&a.content&&(I+=a.content,S(p=>{const g=[...p],q=g[g.length-1];return g[g.length-1]={...q,content:q.content+a.content,isStreaming:!0},g})),a.type==="done"&&(z=a.citations??[])}catch{}}}S(F=>{const t=[...F];return t[t.length-1]={role:"assistant",content:I,citations:z,isStreaming:!1},t}),(m||x||R)&&o({type:m?"note":x?"card":"map",content:I,title:r.replace(/^\/(note|card|flashcard|map|diagram|save)\s*/i,"").trim()})}catch(j){S(P=>{const $=[...P];return $[$.length-1]={role:"assistant",content:`Connection error: ${j instanceof Error?j.message:"Unknown"}`},$})}finally{M(!1)}},[d,l,T,o]),y=r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),i())};return l?e.jsxs("div",{className:"flex flex-col h-full",children:[v&&e.jsxs("div",{className:"shrink-0 px-3 py-2 border-b-2 border-primary/30 bg-black/40",children:[e.jsxs("div",{className:"flex items-center gap-1 overflow-x-auto",children:[f.map((r,m)=>{const x=m<u,R=m===u&&!c;return e.jsxs("div",{className:"flex items-center shrink-0",children:[m>0&&e.jsx(Le,{className:"w-2.5 h-2.5 text-muted-foreground/40 mx-0.5"}),e.jsxs("div",{className:`px-1.5 py-0.5 border text-[10px] font-terminal flex items-center gap-1 ${R?"border-primary bg-primary/20 text-primary":x?"border-muted-foreground/30 bg-muted-foreground/10 text-muted-foreground/60 line-through":"border-muted-foreground/20 text-muted-foreground/40"}`,children:[x&&e.jsx(fe,{className:"w-2.5 h-2.5"}),r.name]})]},r.id)}),!c&&w&&e.jsx("button",{onClick:w,className:"shrink-0 ml-2 px-2 py-0.5 border border-primary text-[10px] font-arcade text-primary hover:bg-primary/20 transition-colors",children:"NEXT"}),c&&e.jsx("span",{className:"shrink-0 ml-2 px-2 py-0.5 text-[10px] font-arcade text-green-400 border border-green-400/50",children:"COMPLETE"})]}),!c&&f[u]&&e.jsxs("div",{className:"mt-1 text-[10px] font-terminal text-muted-foreground",children:[e.jsx("span",{className:"text-primary",children:f[u].category.toUpperCase()})," ","· ~",f[u].duration,"min"]})]}),e.jsxs("div",{ref:E,className:"flex-1 overflow-y-auto p-3 space-y-3",children:[L.length===0&&e.jsxs("div",{className:"text-center py-8 space-y-2",children:[e.jsx("div",{className:"font-arcade text-xs text-primary",children:"SESSION STARTED"}),e.jsx("div",{className:"font-terminal text-xs text-muted-foreground",children:"Ask a question to begin learning. Use /note, /card, or /map for artifacts."})]}),L.map((r,m)=>e.jsx("div",{className:`flex ${r.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[85%] px-3 py-2 text-xs font-terminal ${r.role==="user"?"bg-primary/20 border-2 border-primary/50 text-foreground":"bg-black/40 border-2 border-muted-foreground/20 text-foreground"}`,children:[r.role==="assistant"?e.jsxs("div",{className:"prose prose-invert prose-xs max-w-none [&_p]:my-1 [&_li]:my-0.5 [&_h1]:text-sm [&_h2]:text-xs [&_h3]:text-xs [&_code]:text-[10px] [&_pre]:text-[10px]",children:[e.jsx($e,{remarkPlugins:[Te],children:r.content||(r.isStreaming?"...":"")}),r.isStreaming&&e.jsx("span",{className:"inline-block w-2 h-3 bg-primary animate-pulse ml-0.5"})]}):e.jsx("div",{children:r.content}),r.citations&&r.citations.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-2 pt-2 border-t border-muted-foreground/20",children:r.citations.map(x=>e.jsxs(D,{variant:"outline",className:"text-[10px] rounded-none",children:["[",x.index,"] ",x.source]},x.index))})]})},m))]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 border-t border-muted-foreground/20",children:[e.jsx("span",{className:"text-[10px] font-terminal text-muted-foreground/50",children:"Commands:"}),e.jsxs(D,{variant:"outline",className:"text-[10px] rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>h("/note "),children:[e.jsx(J,{className:"w-2.5 h-2.5 mr-1"}),"/note"]}),e.jsxs(D,{variant:"outline",className:"text-[10px] rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>h("/card "),children:[e.jsx(ye,{className:"w-2.5 h-2.5 mr-1"}),"/card"]}),e.jsxs(D,{variant:"outline",className:"text-[10px] rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>h("/map "),children:[e.jsx(ve,{className:"w-2.5 h-2.5 mr-1"}),"/map"]}),e.jsx("div",{className:"flex-1"}),e.jsxs(U,{variant:"ghost",size:"sm",onClick:N,className:"text-[10px] font-terminal text-destructive hover:text-destructive h-5 px-2",children:[e.jsx(Ge,{className:"w-2.5 h-2.5 mr-1"}),"END"]})]}),e.jsxs("div",{className:"flex items-center gap-2 p-3 border-t-2 border-muted-foreground/30",children:[e.jsx("input",{ref:s,value:d,onChange:r=>h(r.target.value),onKeyDown:y,placeholder:"Ask a question...",disabled:T,className:"flex-1 bg-black/60 border-2 border-muted-foreground/30 px-3 py-2 text-xs font-terminal text-foreground placeholder:text-muted-foreground/50 focus:border-primary focus:outline-none disabled:opacity-50"}),e.jsx(U,{onClick:i,disabled:!d.trim()||T,className:"rounded-none border-2 border-primary h-9 w-9 p-0",children:T?e.jsx(ne,{className:"w-4 h-4 animate-spin"}):e.jsx(Me,{className:"w-4 h-4"})})]})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"font-arcade text-sm text-muted-foreground",children:"NO ACTIVE SESSION"}),e.jsx("div",{className:"font-terminal text-xs text-muted-foreground/70",children:"Configure content filter and start a session"})]})})}const Ze={note:J,card:ye,map:ve},Je={note:"text-blue-400",card:"text-yellow-400",map:"text-green-400"};function We({sessionId:l,artifacts:o,turnCount:N,mode:f,topic:u,startedAt:w,recentSessions:v,onResumeSession:c}){const L=pe(),[S,d]=n.useState(null),[h,T]=n.useState(null),M=async s=>{try{await _.tutor.deleteSession(s),b.success("Session deleted"),L.invalidateQueries({queryKey:["tutor-sessions"]}),d(null)}catch(i){b.error(`Delete failed: ${i instanceof Error?i.message:"Unknown"}`)}},E=async s=>{T(s.session_id);try{const i=await _.tutor.getSession(s.session_id);if(!i.turns||i.turns.length===0){b.error("No turns to save");return}const y=[`# Tutor: ${s.topic||s.mode}`,`**Date:** ${new Date(s.started_at).toLocaleDateString()}`,`**Mode:** ${s.mode} | **Turns:** ${s.turn_count}`,"","---",""];for(const x of i.turns)y.push(`## Q${x.turn_number}`),y.push(x.question),y.push(""),x.answer&&(y.push("**Answer:**"),y.push(x.answer),y.push(""));const m=`Study Sessions/${`Tutor - ${(s.topic||s.mode).replace(/[^a-zA-Z0-9 ]/g,"").trim()}`}.md`;await _.obsidian.append(m,y.join(`
`)),b.success(`Saved to Obsidian: ${m}`)}catch(i){b.error(`Save failed: ${i instanceof Error?i.message:"Unknown"}`)}finally{T(null)}};return e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:`shrink-0 ${V} pb-2 border-b-2 border-secondary/30`,children:e.jsx("div",{className:ge,children:"ARTIFACTS"})}),e.jsx(he,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:`${V} space-y-3`,children:[l?e.jsxs("div",{className:"space-y-2 pb-3 border-b border-muted-foreground/20",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap",children:[e.jsx(D,{variant:"outline",className:`${K} h-5 px-1.5`,children:f}),e.jsx(D,{variant:"outline",className:`${K} h-5 px-1.5 text-primary`,children:"FIRST PASS"})]}),u&&e.jsx("div",{className:`${G} text-sm`,children:u}),e.jsxs("div",{className:`flex items-center gap-3 ${O}`,children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:k}),N," turns"]}),w&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(le,{className:k}),new Date(w).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]}):e.jsx("div",{className:`${G} text-muted-foreground/50 py-3 text-center`,children:"No active session"}),o.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:se,children:"Artifacts"}),o.map((s,i)=>{const y=Ze[s.type],r=Je[s.type];return e.jsxs("div",{className:"border-2 border-muted-foreground/20 p-2.5 hover:border-primary/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(y,{className:`${te} ${r}`}),e.jsx("span",{className:`${G} text-sm truncate flex-1`,children:s.title||`${s.type} #${i+1}`})]}),s.content&&e.jsx("div",{className:`${O} mt-1 line-clamp-2`,children:s.content.slice(0,100)})]},i)})]}),l&&o.length===0&&e.jsxs("div",{className:"text-center space-y-1 py-4",children:[e.jsx(je,{className:`${we} text-muted-foreground/30 mx-auto`}),e.jsx("div",{className:`${O} text-muted-foreground/50`,children:"No artifacts yet"}),e.jsx("div",{className:`${O} text-muted-foreground/30`,children:"Use /note, /card, or /map"})]}),v.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-muted-foreground/20",children:[e.jsx("div",{className:se,children:"Recent Sessions"}),v.slice(0,8).map(s=>e.jsxs("div",{className:"border-2 border-muted-foreground/10 hover:border-muted-foreground/30 transition-colors",children:[e.jsxs("button",{onClick:()=>c(s.session_id),className:"w-full text-left px-3 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{variant:"outline",className:`${K} h-5 px-1.5 shrink-0 ${s.status==="active"?"text-green-400 border-green-400/50":"text-muted-foreground"}`,children:s.status==="active"?"LIVE":"DONE"}),e.jsx("span",{className:"font-terminal text-sm truncate flex-1",children:s.topic||s.mode})]}),e.jsxs("div",{className:`flex items-center gap-2 mt-1.5 ${O}`,children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:k}),s.turn_count]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(le,{className:k}),new Date(s.started_at).toLocaleDateString()]}),e.jsx(D,{variant:"outline",className:`${K} h-4 px-1 ml-auto`,children:s.mode})]})]}),e.jsxs("div",{className:"flex items-center border-t border-muted-foreground/10 px-2 py-1",children:[e.jsxs(U,{variant:"ghost",size:"sm",className:"h-6 px-2 rounded-none text-muted-foreground hover:text-primary font-terminal text-[10px]",disabled:h===s.session_id,onClick:i=>{i.stopPropagation(),E(s)},children:[e.jsx(Ae,{className:`${k} mr-1`}),h===s.session_id?"SAVING...":"SAVE"]}),e.jsx("div",{className:"ml-auto",children:S===s.session_id?e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("span",{className:"font-terminal text-[10px] text-red-400 mr-1",children:"Delete?"}),e.jsx(U,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-red-400 hover:text-red-300 hover:bg-red-400/10",onClick:i=>{i.stopPropagation(),M(s.session_id)},children:e.jsx(fe,{className:k})}),e.jsx(U,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-muted-foreground hover:text-foreground",onClick:i=>{i.stopPropagation(),d(null)},children:e.jsx(Ne,{className:k})})]}):e.jsx(U,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-muted-foreground hover:text-red-400",onClick:i=>{i.stopPropagation(),d(s.session_id)},children:e.jsx(be,{className:k})})})]})]},s.session_id))]})]})})]})}function ht(){const l=pe(),[o,N]=n.useState(null),[f,u]=n.useState(!1),[w,v]=n.useState(),[c,L]=n.useState([]),[S,d]=n.useState("Core"),[h,T]=n.useState(),[M,E]=n.useState(0),[s,i]=n.useState([]),[y,r]=n.useState(""),[m,x]=n.useState("codex"),[R,j]=n.useState([]),[P,$]=n.useState(0),[C,I]=n.useState(null),{data:z=[]}=Y({queryKey:["tutor-sessions"],queryFn:()=>_.tutor.listSessions({limit:10})}),F=n.useCallback(async()=>{u(!0);try{const a=await _.tutor.createSession({course_id:w,phase:"first_pass",mode:S,topic:y||void 0,content_filter:{...c.length>0?{material_ids:c}:{},model:m},method_chain_id:h});if(N(a.session_id),I(a.started_at),j([]),$(0),E(a.current_block_index??0),h){const p=await _.tutor.getSession(a.session_id);p.chain_blocks&&i(p.chain_blocks.map(g=>({id:g.id,name:g.name,category:g.category,duration:g.default_duration_min})))}else i([]);b.success("Tutor session started"),l.invalidateQueries({queryKey:["tutor-sessions"]})}catch(a){b.error(`Failed to start session: ${a instanceof Error?a.message:"Unknown"}`)}finally{u(!1)}},[w,S,y,c,m,h,l]),t=n.useCallback(async()=>{if(o)try{await _.tutor.endSession(o),b.success("Session ended"),N(null),j([]),$(0),I(null),E(0),i([]),l.invalidateQueries({queryKey:["tutor-sessions"]})}catch(a){b.error(`Failed to end session: ${a instanceof Error?a.message:"Unknown"}`)}},[o,l]),A=n.useCallback(async a=>{if(o)try{const p=await _.tutor.createArtifact(o,{type:a.type,content:a.content,title:a.title}),g={type:a.type,title:a.title||`${a.type} #${R.length+1}`,content:a.content.slice(0,200),createdAt:new Date().toISOString(),cardId:p.card_id};j(q=>[...q,g]),b.success(`${a.type.charAt(0).toUpperCase()+a.type.slice(1)} created`)}catch(p){b.error(`Failed to create artifact: ${p instanceof Error?p.message:"Unknown"}`)}},[o,R.length]),Q=n.useCallback(async()=>{if(o)try{const a=await _.tutor.advanceBlock(o);E(a.block_index),a.complete?b.success("Chain complete!"):b.success(`Advanced to: ${a.block_name}`)}catch(a){b.error(`Failed to advance block: ${a instanceof Error?a.message:"Unknown"}`)}},[o]),B=n.useCallback(async a=>{try{const p=await _.tutor.getSession(a);if(N(p.session_id),$(p.turn_count),I(p.started_at),d(p.mode),r(p.topic||""),v(p.course_id??void 0),p.artifacts_json)try{const g=JSON.parse(p.artifacts_json);Array.isArray(g)&&j(g.map(q=>({type:q.type,title:q.title,content:"",createdAt:q.created_at})))}catch{j([])}b.success("Session resumed")}catch(p){b.error(`Failed to resume session: ${p instanceof Error?p.message:"Unknown"}`)}},[]);return e.jsx(Se,{children:e.jsxs("div",{className:"h-[calc(100vh-140px)] flex gap-2",children:[e.jsx(W,{className:"w-64 shrink-0 bg-black/40 border-2 border-primary rounded-none overflow-y-auto",children:e.jsx(Ve,{courseId:w,setCourseId:v,selectedMaterials:c,setSelectedMaterials:L,mode:S,setMode:d,chainId:h,setChainId:T,topic:y,setTopic:r,model:m,setModel:x,onStartSession:F,isStarting:f,hasActiveSession:!!o})}),e.jsx(W,{className:"flex-1 bg-black/60 border-2 border-primary rounded-none flex flex-col min-w-0",children:e.jsx(He,{sessionId:o,onArtifactCreated:A,onSessionEnd:t,chainBlocks:s,currentBlockIndex:M,onAdvanceBlock:Q})}),e.jsx(W,{className:"w-64 shrink-0 bg-black/40 border-2 border-secondary rounded-none overflow-y-auto",children:e.jsx(We,{sessionId:o,artifacts:R,turnCount:P,mode:S,topic:y,startedAt:C,onCreateArtifact:A,recentSessions:z,onResumeSession:B})})]})})}export{ht as default};
